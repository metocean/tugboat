// Generated by CoffeeScript 1.8.0
var ess, init_errors, series;

require('colors');

series = function(tasks, callback) {
  var next, result;
  tasks = tasks.slice(0);
  next = function(cb) {
    var task;
    if (tasks.length === 0) {
      return cb();
    }
    task = tasks.shift();
    return task(function() {
      return next(cb);
    });
  };
  result = function(cb) {
    return next(cb);
  };
  if (callback != null) {
    result(callback);
  }
  return result;
};

ess = function(num, s, p) {
  if (num === 1) {
    return s;
  } else {
    return p;
  }
};

init_errors = function(errors) {
  var e, err, index, _i, _j, _len, _len1, _ref;
  for (_i = 0, _len = errors.length; _i < _len; _i++) {
    e = errors[_i];
    console.error();
    console.error(("  " + e.path).red);
    _ref = e.errors;
    for (index = _j = 0, _len1 = _ref.length; _j < _len1; index = ++_j) {
      err = _ref[index];
      if (err.name == null) {
        console.error(err);
        continue;
      }
      if (err.name === 'YAMLException') {
        console.error("  " + (index + 1) + ") " + e.path + ":" + (err.mark.line + 1));
        console.error(err.message);
      } else if (err.name === 'TUGBOATFormatException') {
        console.error("  " + (index + 1) + ") " + err.message);
      } else {
        console.error("  " + (index + 1) + ") Unknown error:");
        console.error(err);
      }
    }
  }
  console.error();
  return process.exit(1);
};

module.exports = {
  status: function(tugboat) {
    return tugboat.init(function(errors) {
      var count;
      if (errors != null) {
        return init_errors(errors);
      }
      count = Object.keys(tugboat._groups).length;
      console.log();
      if (count === 0) {
        console.log('  There are no groups defined in this directory'.magenta);
      } else {
        console.log("  " + (count.toString().green) + " group " + (ess(count, 'definition', 'definitions')) + " available.");
      }
      return tugboat.ducke.ping(function(err, isUp) {
        if ((err != null) || !isUp) {
          console.error();
          console.error('  docker is down'.red);
          console.error();
          return process.exit(1);
        } else {
          return tugboat.ducke.ps(function(err, results) {
            var running, stopped;
            if ((err != null) || results.length === 0) {
              console.error();
              console.error('  There are no docker containers on this system'.magenta);
              console.error();
            } else {
              running = results.filter(function(d) {
                return d.inspect.State.Running;
              }).length;
              stopped = results.length - running;
              console.error();
              console.error("  There " + (ess(running, 'is', 'are')) + " " + (running.toString().green) + " running container" + (ess(running, '', 's')) + " and " + (stopped.toString().red) + " stopped container" + (ess(stopped, '', 's')));
              console.error();
            }
            return process.exit(1);
          });
        }
      });
    });
  },
  build: function(tugboat, names) {
    return tugboat.init(function(errors) {
      var group, haderror, name, tasks, _fn, _i, _j, _len, _len1;
      if (errors != null) {
        return init_errors(errors);
      }
      console.log();
      if (Object.keys(tugboat._groups).length === 0) {
        console.error('  There are no groups defined in this directory'.magenta);
        console.error();
        process.exit(1);
      }
      if (names.length === 0) {
        names = Object.keys(tugboat._groups);
      }
      haderror = false;
      for (_i = 0, _len = names.length; _i < _len; _i++) {
        name = names[_i];
        if (tugboat._groups[name] == null) {
          console.error(("  The group '" + name + "' is not available in this directory").red);
          console.error();
          haderror = true;
        }
      }
      if (haderror) {
        process.exit(1);
      }
      tasks = [];
      _fn = function(group) {
        return tasks.push(function(cb) {
          var config, container, grouptasks, _fn1, _ref;
          grouptasks = [];
          console.log("  Building " + name.blue + "...");
          _ref = group.containers;
          _fn1 = function(container, config) {
            var output;
            output = container.cyan;
            return grouptasks.push(function(cb) {
              var results, run;
              while (output.length < 32) {
                output += ' ';
              }
              process.stdout.write("    " + output + " ");
              if (config.build == null) {
                console.log('-'.magenta);
                return cb();
              }
              results = '';
              run = function(message) {
                results += message;
                return results += '\n';
              };
              return tugboat.build(group, container, run, function(err) {
                if (err != null) {
                  console.error('failed'.red);
                  console.error(err);
                  if (results.length !== 0) {
                    console.error(results);
                  }
                  console.error();
                  return cb();
                }
                console.log('done'.green);
                return cb();
              });
            });
          };
          for (container in _ref) {
            config = _ref[container];
            _fn1(container, config);
          }
          return series(grouptasks, function() {
            console.log();
            return cb();
          });
        });
      };
      for (_j = 0, _len1 = names.length; _j < _len1; _j++) {
        name = names[_j];
        group = tugboat._groups[name];
        _fn(group);
      }
      return series(tasks, function() {});
    });
  },
  ls: function(tugboat, names) {
    return tugboat.init(function(errors) {
      var container, count, group, name, _, _i, _len, _ref, _ref1, _results;
      if (errors != null) {
        return init_errors(errors);
      }
      console.log();
      if (Object.keys(tugboat._groups).length === 0) {
        console.log('  There are no groups defined in this directory'.magenta);
        console.log();
        return;
      }
      if (names.length === 0) {
        _ref = tugboat._groups;
        for (name in _ref) {
          group = _ref[name];
          while (name.length < 26) {
            name += ' ';
          }
          count = Object.keys(group.containers).length;
          console.log("  " + name.blue + " " + (count.toString().green) + " container" + (ess(count, '', 's')) + " defined in group");
        }
        console.log();
        return;
      }
      _results = [];
      for (_i = 0, _len = names.length; _i < _len; _i++) {
        name = names[_i];
        if (tugboat._groups[name] == null) {
          console.error(("  The group '" + name + "' is not available in this directory").red);
          console.error();
          continue;
        }
        group = tugboat._groups[name];
        if (Object.keys(group.containers).length === 0) {
          console.log("  " + name.blue);
          console.log('    No containers defined in group'.magenta);
          _results.push(console.log());
        } else {
          console.log("  " + name.blue + ":");
          _ref1 = group.containers;
          for (container in _ref1) {
            _ = _ref1[container];
            console.log("    " + container.cyan);
          }
          _results.push(console.log());
        }
      }
      return _results;
    });
  }
};
